{
    "openapi": "3.0.3",
    "info": {
        "title": "TraceOps API - Field Service Management",
        "description": "API para gestión de órdenes SCRC, técnicos, brigadas, vehículos y tracking GPS en tiempo real.",
        "version": "1.0.0",
        "contact": {
            "name": "TraceOps Support"
        }
    },
    "servers": [
        {
            "url": "https://dashboard-backend.zvkdyr.easypanel.host",
            "description": "Producción"
        },
        {
            "url": "http://localhost:3000",
            "description": "Desarrollo Local"
        }
    ],
    "tags": [
        {
            "name": "Auth",
            "description": "Autenticación y usuarios"
        },
        {
            "name": "Orders",
            "description": "Gestión de órdenes SCRC"
        },
        {
            "name": "Brigades",
            "description": "Gestión de brigadas/cuadrillas"
        },
        {
            "name": "Vehicles",
            "description": "Gestión de vehículos"
        },
        {
            "name": "GPS",
            "description": "Tracking y ubicación en tiempo real"
        },
        {
            "name": "Export",
            "description": "Exportación de datos"
        },
        {
            "name": "Schedules",
            "description": "Jornadas de trabajo"
        }
    ],
    "paths": {
        "/api/auth/login": {
            "post": {
                "tags": [
                    "Auth"
                ],
                "summary": "Iniciar sesión",
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "required": [
                                    "email",
                                    "password"
                                ],
                                "properties": {
                                    "email": {
                                        "type": "string",
                                        "example": "admin@traceops.com"
                                    },
                                    "password": {
                                        "type": "string",
                                        "example": "admin123"
                                    }
                                }
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Login exitoso",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "object",
                                    "properties": {
                                        "token": {
                                            "type": "string"
                                        },
                                        "user": {
                                            "type": "object"
                                        }
                                    }
                                }
                            }
                        }
                    },
                    "401": {
                        "description": "Credenciales inválidas"
                    }
                }
            }
        },
        "/api/auth/register": {
            "post": {
                "tags": [
                    "Auth"
                ],
                "summary": "Registrar usuario (solo admin)",
                "security": [
                    {
                        "bearerAuth": []
                    }
                ],
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "required": [
                                    "email",
                                    "password",
                                    "name"
                                ],
                                "properties": {
                                    "email": {
                                        "type": "string"
                                    },
                                    "password": {
                                        "type": "string"
                                    },
                                    "name": {
                                        "type": "string"
                                    },
                                    "role": {
                                        "type": "string",
                                        "enum": [
                                            "admin",
                                            "supervisor",
                                            "driver"
                                        ]
                                    }
                                }
                            }
                        }
                    }
                },
                "responses": {
                    "201": {
                        "description": "Usuario creado"
                    },
                    "400": {
                        "description": "Email ya existe"
                    }
                }
            }
        },
        "/api/scrc/ingest": {
            "post": {
                "tags": [
                    "Orders"
                ],
                "summary": "Cargar Excel de asignaciones",
                "description": "Procesa archivo Excel con órdenes SCRC. El body debe ser JSON con array base64 del archivo.",
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "properties": {
                                    "fileData": {
                                        "type": "string",
                                        "description": "Base64 del archivo Excel"
                                    },
                                    "orders": {
                                        "type": "array",
                                        "description": "O array de órdenes directo"
                                    }
                                }
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Órdenes procesadas"
                    }
                }
            }
        },
        "/api/scrc/orders": {
            "get": {
                "tags": [
                    "Orders"
                ],
                "summary": "Listar órdenes",
                "parameters": [
                    {
                        "name": "status",
                        "in": "query",
                        "schema": {
                            "type": "string"
                        }
                    },
                    {
                        "name": "brigade_id",
                        "in": "query",
                        "schema": {
                            "type": "integer"
                        }
                    },
                    {
                        "name": "municipio",
                        "in": "query",
                        "schema": {
                            "type": "string"
                        }
                    },
                    {
                        "name": "date_from",
                        "in": "query",
                        "schema": {
                            "type": "string",
                            "format": "date"
                        }
                    },
                    {
                        "name": "date_to",
                        "in": "query",
                        "schema": {
                            "type": "string",
                            "format": "date"
                        }
                    },
                    {
                        "name": "limit",
                        "in": "query",
                        "schema": {
                            "type": "integer",
                            "default": 100
                        }
                    },
                    {
                        "name": "offset",
                        "in": "query",
                        "schema": {
                            "type": "integer",
                            "default": 0
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Lista de órdenes",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "object",
                                    "properties": {
                                        "success": {
                                            "type": "boolean"
                                        },
                                        "orders": {
                                            "type": "array"
                                        },
                                        "total": {
                                            "type": "integer"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        "/api/scrc/orders/{id}/complete": {
            "patch": {
                "tags": [
                    "Orders"
                ],
                "summary": "Cerrar orden",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "properties": {
                                    "result_code": {
                                        "type": "string",
                                        "example": "01"
                                    },
                                    "observations": {
                                        "type": "string"
                                    },
                                    "photo_url": {
                                        "type": "string"
                                    },
                                    "latitude": {
                                        "type": "number"
                                    },
                                    "longitude": {
                                        "type": "number"
                                    }
                                }
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Orden cerrada"
                    }
                }
            }
        },
        "/api/scrc/stats": {
            "get": {
                "tags": [
                    "Orders"
                ],
                "summary": "Estadísticas de órdenes",
                "responses": {
                    "200": {
                        "description": "Estadísticas",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "object",
                                    "properties": {
                                        "total": {
                                            "type": "integer"
                                        },
                                        "pending": {
                                            "type": "integer"
                                        },
                                        "completed": {
                                            "type": "integer"
                                        },
                                        "cancelled": {
                                            "type": "integer"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        "/api/scrc/financials": {
            "get": {
                "tags": [
                    "Orders"
                ],
                "summary": "Datos financieros (PxQ)",
                "responses": {
                    "200": {
                        "description": "Datos financieros"
                    }
                }
            }
        },
        "/api/scrc/update-debt": {
            "post": {
                "tags": [
                    "Orders"
                ],
                "summary": "Actualizar deudas desde Balanza",
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "properties": {
                                    "nics": {
                                        "type": "array",
                                        "items": {
                                            "type": "string"
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Deudas actualizadas"
                    }
                }
            }
        },
        "/api/brigades": {
            "get": {
                "tags": [
                    "Brigades"
                ],
                "summary": "Listar brigadas",
                "responses": {
                    "200": {
                        "description": "Lista de brigadas",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "object",
                                    "properties": {
                                        "success": {
                                            "type": "boolean"
                                        },
                                        "brigades": {
                                            "type": "array"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            },
            "post": {
                "tags": [
                    "Brigades"
                ],
                "summary": "Crear brigada",
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "required": [
                                    "name"
                                ],
                                "properties": {
                                    "name": {
                                        "type": "string"
                                    },
                                    "type": {
                                        "type": "string",
                                        "example": "SCR LIVIANA"
                                    },
                                    "capacity_per_day": {
                                        "type": "integer",
                                        "default": 30
                                    },
                                    "current_zone": {
                                        "type": "string"
                                    }
                                }
                            }
                        }
                    }
                },
                "responses": {
                    "201": {
                        "description": "Brigada creada"
                    }
                }
            }
        },
        "/api/brigades/{id}": {
            "put": {
                "tags": [
                    "Brigades"
                ],
                "summary": "Actualizar brigada",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "properties": {
                                    "name": {
                                        "type": "string"
                                    },
                                    "type": {
                                        "type": "string"
                                    },
                                    "status": {
                                        "type": "string"
                                    },
                                    "capacity_per_day": {
                                        "type": "integer"
                                    }
                                }
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Brigada actualizada"
                    }
                }
            },
            "delete": {
                "tags": [
                    "Brigades"
                ],
                "summary": "Eliminar brigada",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Brigada eliminada"
                    }
                }
            }
        },
        "/api/vehicles": {
            "get": {
                "tags": [
                    "Vehicles"
                ],
                "summary": "Listar vehículos",
                "responses": {
                    "200": {
                        "description": "Lista de vehículos",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "object",
                                    "properties": {
                                        "success": {
                                            "type": "boolean"
                                        },
                                        "vehicles": {
                                            "type": "array"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            },
            "post": {
                "tags": [
                    "Vehicles"
                ],
                "summary": "Crear vehículo",
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "required": [
                                    "plate"
                                ],
                                "properties": {
                                    "plate": {
                                        "type": "string",
                                        "example": "ABC123"
                                    },
                                    "type": {
                                        "type": "string",
                                        "enum": [
                                            "car",
                                            "motorcycle",
                                            "truck"
                                        ]
                                    },
                                    "brand": {
                                        "type": "string"
                                    },
                                    "model": {
                                        "type": "string"
                                    },
                                    "fuel_type": {
                                        "type": "string"
                                    },
                                    "km_per_gallon": {
                                        "type": "number"
                                    }
                                }
                            }
                        }
                    }
                },
                "responses": {
                    "201": {
                        "description": "Vehículo creado"
                    }
                }
            }
        },
        "/api/vehicles/{id}": {
            "get": {
                "tags": [
                    "Vehicles"
                ],
                "summary": "Detalle de vehículo",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Detalle del vehículo"
                    }
                }
            },
            "put": {
                "tags": [
                    "Vehicles"
                ],
                "summary": "Actualizar vehículo",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Vehículo actualizado"
                    }
                }
            },
            "delete": {
                "tags": [
                    "Vehicles"
                ],
                "summary": "Eliminar vehículo",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Vehículo eliminado"
                    }
                }
            }
        },
        "/api/vehicles/{id}/assign-brigade": {
            "post": {
                "tags": [
                    "Vehicles"
                ],
                "summary": "Asignar vehículo a brigada",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "properties": {
                                    "brigade_id": {
                                        "type": "integer"
                                    }
                                }
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Vehículo asignado"
                    }
                }
            }
        },
        "/api/scrc/tech-location": {
            "post": {
                "tags": [
                    "GPS"
                ],
                "summary": "Enviar ubicación del técnico",
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "required": [
                                    "technician_id",
                                    "latitude",
                                    "longitude"
                                ],
                                "properties": {
                                    "technician_id": {
                                        "type": "integer"
                                    },
                                    "brigade_id": {
                                        "type": "integer"
                                    },
                                    "latitude": {
                                        "type": "number",
                                        "example": 10.9878
                                    },
                                    "longitude": {
                                        "type": "number",
                                        "example": -74.7889
                                    },
                                    "accuracy": {
                                        "type": "number"
                                    },
                                    "battery": {
                                        "type": "number"
                                    }
                                }
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Ubicación recibida"
                    }
                }
            }
        },
        "/api/scrc/tech-locations": {
            "get": {
                "tags": [
                    "GPS"
                ],
                "summary": "Obtener ubicaciones en tiempo real",
                "responses": {
                    "200": {
                        "description": "Ubicaciones de técnicos",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "object",
                                    "properties": {
                                        "locations": {
                                            "type": "array"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        "/api/scrc/gps-alerts": {
            "get": {
                "tags": [
                    "GPS"
                ],
                "summary": "Alertas de GPS apagado",
                "responses": {
                    "200": {
                        "description": "Lista de alertas"
                    }
                }
            }
        },
        "/api/scrc/export/siprem": {
            "get": {
                "tags": [
                    "Export"
                ],
                "summary": "Exportar formato SIPREM",
                "parameters": [
                    {
                        "name": "date_from",
                        "in": "query",
                        "schema": {
                            "type": "string",
                            "format": "date"
                        }
                    },
                    {
                        "name": "date_to",
                        "in": "query",
                        "schema": {
                            "type": "string",
                            "format": "date"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Archivo Excel",
                        "content": {
                            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": {}
                        }
                    }
                }
            }
        },
        "/api/scrc/export/consolidado": {
            "get": {
                "tags": [
                    "Export"
                ],
                "summary": "Exportar consolidado",
                "responses": {
                    "200": {
                        "description": "Archivo Excel",
                        "content": {
                            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": {}
                        }
                    }
                }
            }
        },
        "/api/schedules": {
            "get": {
                "tags": [
                    "Schedules"
                ],
                "summary": "Listar jornadas",
                "responses": {
                    "200": {
                        "description": "Lista de jornadas"
                    }
                }
            },
            "post": {
                "tags": [
                    "Schedules"
                ],
                "summary": "Crear jornada",
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "properties": {
                                    "technician_id": {
                                        "type": "integer"
                                    },
                                    "day_of_week": {
                                        "type": "integer",
                                        "minimum": 0,
                                        "maximum": 6
                                    },
                                    "start_time": {
                                        "type": "string",
                                        "example": "08:00"
                                    },
                                    "end_time": {
                                        "type": "string",
                                        "example": "17:00"
                                    }
                                }
                            }
                        }
                    }
                },
                "responses": {
                    "201": {
                        "description": "Jornada creada"
                    }
                }
            }
        }
    },
    "components": {
        "securitySchemes": {
            "bearerAuth": {
                "type": "http",
                "scheme": "bearer",
                "bearerFormat": "JWT"
            }
        }
    }
}